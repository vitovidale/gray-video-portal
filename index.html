<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gray Video Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Seus estilos CSS personalizados e da paleta de cinzas aqui */
        body {
            background-color: #f0f0f0; /* Cinza bem claro */
            color: #333333; /* Cinza escuro para texto */
        }
        .bg-gray-800 { background-color: #333333; }
        .text-gray-100 { color: #f9f9f9; }
        /* Adicione mais tons de cinza conforme o design do Lovable AI */

        /* Estilo para o spinner de loading */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #666; /* Um cinza m√©dio para o spinner */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased bg-gray-100 text-gray-800 flex flex-col min-h-screen">
    <header class="bg-gray-800 text-gray-100 p-4 shadow-md">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Video Portal</h1>
            <div>
                <span id="loggedInUser" class="mr-4"></span>
                <button id="logoutBtn" class="bg-gray-700 hover:bg-gray-600 text-gray-100 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline hidden">Logout</button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto flex-grow p-4">
        <section id="authSection" class="bg-white p-6 rounded shadow-md w-full max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-center" id="authTitle">Login</h2>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                    <input type="text" id="username" name="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                    <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="emailField" class="hidden">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" id="submitAuthBtn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center">
                        <span id="authSpinner" class="spinner mr-2 hidden"></span> <span id="authBtnText">Login</span>
                    </button>
                    <a href="#" id="toggleAuth" class="inline-block align-baseline font-bold text-sm text-gray-600 hover:text-gray-800">Register</a>
                </div>
                <p id="authMessage" class="text-sm text-center"></p>
            </form>
        </section>

        <section id="uploadSection" class="hidden bg-white p-6 rounded shadow-md w-full max-w-2xl mx-auto mt-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Upload Video</h2>
            <form id="uploadForm" class="space-y-4">
                <div>
                    <label for="videoFile" class="block text-gray-700 text-sm font-bold mb-2">Select Video:</label>
                    <input type="file" id="videoFile" name="videoFile" accept="video/*" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <button type="submit" id="uploadBtn" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline flex items-center justify-center">
                    <span id="uploadSpinner" class="spinner mr-2 hidden"></span> <span id="uploadBtnText">Upload</span>
                </button>
                <p id="uploadMessage" class="text-sm text-center"></p>
            </form>
            <div id="dropArea" class="mt-4 border-2 border-dashed border-gray-400 rounded-lg p-8 text-center text-gray-500 cursor-pointer hover:border-gray-600">
                Drag & Drop Video Here
            </div>
        </section>

        <section id="videoListSection" class="hidden bg-white p-6 rounded shadow-md w-full max-w-5xl mx-auto mt-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Your Videos</h2>
            <div class="mb-4 text-right">
                <button id="refreshVideosBtn" class="bg-gray-700 hover:bg-gray-600 text-gray-100 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Refresh</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filename</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="videoTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
                <p id="noVideosMessage" class="text-center text-gray-500 mt-4 hidden">No videos uploaded yet.</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-100 p-4 text-center mt-8">
        <p>&copy; 2025 Video Portal. All rights reserved.</p>
    </footer>

    <script>
        // --- API Base URLs ---
        // IMPORTANT: These URLs must be relative paths when using Nginx as a proxy.
        // Nginx will forward /login to http://user-auth-service:5000/login, etc.
        const AUTH_BASE_URL = ''; // No base URL, requests go to root which is handled by Nginx
        const VIDEO_BASE_URL = ''; // No base URL, requests go to root which is handled by Nginx

        // --- DOM Elements ---
        const authSection = document.getElementById('authSection');
        const uploadSection = document.getElementById('uploadSection');
        const videoListSection = document.getElementById('videoListSection');
        const loggedInUserSpan = document.getElementById('loggedInUser');
        const logoutBtn = document.getElementById('logoutBtn');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const submitAuthBtn = document.getElementById('submitAuthBtn');
        const authBtnText = document.getElementById('authBtnText');
        const authSpinner = document.getElementById('authSpinner');
        const toggleAuthLink = document.getElementById('toggleAuth');
        const emailField = document.getElementById('emailField');
        const authMessage = document.getElementById('authMessage');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const emailInput = document.getElementById('email');

        const uploadForm = document.getElementById('uploadForm');
        const videoFileInput = document.getElementById('videoFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const uploadMessage = document.getElementById('uploadMessage');
        const dropArea = document.getElementById('dropArea');

        const videoTableBody = document.getElementById('videoTableBody');
        const refreshVideosBtn = document.getElementById('refreshVideosBtn');
        const noVideosMessage = document.getElementById('noVideosMessage');

        let isLoginMode = true; // State for login/register toggle

        // --- Helper Functions ---
        function showSection(sectionId) {
            authSection.classList.add('hidden');
            uploadSection.classList.add('hidden');
            videoListSection.classList.add('hidden');
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function setLoading(button, spinner, textSpan, isLoading) {
            if (isLoading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                textSpan.textContent = 'Loading...';
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                textSpan.textContent = textSpan.dataset.originalText; // Restore original text
            }
        }

        function displayMessage(element, message, isError = false) {
            element.textContent = message;
            element.className = isError ? 'text-red-500 text-sm text-center mt-2' : 'text-green-500 text-sm text-center mt-2';
        }

        function getToken() {
            return localStorage.getItem('jwtToken');
        }

        function setToken(token) {
            localStorage.setItem('jwtToken', token);
        }

        function removeToken() {
            localStorage.removeItem('jwtToken');
        }

        async function makeApiRequest(url, method, body = null, isMultipart = false) {
            const token = getToken();
            const headers = {};
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            let requestOptions = {
                method: method,
                headers: headers,
            };

            if (body) {
                if (isMultipart) {
                    // For FormData, do not set Content-Type header manually; browser does it
                    delete requestOptions.headers['Content-Type'];
                    requestOptions.body = body;
                } else {
                    headers['Content-Type'] = 'application/json';
                    requestOptions.body = JSON.stringify(body);
                }
            }

            try {
                const response = await fetch(url, requestOptions);
                if (response.status === 401 || response.status === 403) {
                    displayMessage(authMessage, "Session expired or unauthorized. Please log in again.", true);
                    removeToken();
                    showSection('authSection');
                    return null; // Indicate failure due to auth
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.error || errorData.message || 'API request failed');
                }
                // Handle download specifically
                if (url.includes('/download') && method === 'GET') {
                    return response.blob(); // Return blob for file download
                }
                return await response.json();
            } catch (error) {
                displayMessage(authMessage, `API Error: ${error.message}`, true);
                throw error; // Re-throw to be caught by specific handlers
            }
        }

        // --- Authentication Logic ---
        async function login() {
            setLoading(submitAuthBtn, authSpinner, authBtnText, true);
            displayMessage(authMessage, "");

            const username = usernameInput.value;
            const password = passwordInput.value;

            try {
                const data = await makeApiRequest(`/login`, 'POST', { username, password }); // Adjusted URL
                if (data && data.token) {
                    setToken(data.token);
                    const user = parseJwt(data.token);
                    loggedInUserSpan.textContent = `Welcome, ${user.username}!`;
                    logoutBtn.classList.remove('hidden');
                    showSection('uploadSection'); // Or direct to video list
                    loadVideos(); // Load videos immediately after login
                    displayMessage(authMessage, "Logged in successfully!", false);
                }
            } catch (error) {
                console.error("Login failed:", error);
                displayMessage(authMessage, `Login failed: ${error.message}`, true);
            } finally {
                setLoading(submitAuthBtn, authSpinner, authBtnText, false);
            }
        }

        async function register() {
            setLoading(submitAuthBtn, authSpinner, authBtnText, true);
            displayMessage(authMessage, "");

            const username = usernameInput.value;
            const password = passwordInput.value;
            const email = emailInput.value;

            try {
                const data = await makeApiRequest(`/register`, 'POST', { username, password, email }); // Adjusted URL
                displayMessage(authMessage, data.message || "Registration successful!", false);
                // After successful registration, switch to login mode
                toggleAuthMode();
            } catch (error) {
                console.error("Registration failed:", error);
                displayMessage(authMessage, `Registration failed: ${error.message}`, true);
            } finally {
                setLoading(submitAuthBtn, authSpinner, authBtnText, false);
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authTitle.textContent = isLoginMode ? 'Login' : 'Register';
            authBtnText.textContent = isLoginMode ? 'Login' : 'Register';
            submitAuthBtn.dataset.originalText = isLoginMode ? 'Login' : 'Register';
            emailField.classList.toggle('hidden', isLoginMode);
            toggleAuthLink.textContent = isLoginMode ? 'Register' : 'Login';
            authMessage.textContent = ""; // Clear messages
            authForm.reset(); // Clear form fields
        }

        function parseJwt (token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        };

        // --- Video Upload Logic ---
        async function uploadVideo(event) {
            event.preventDefault();
            setLoading(uploadBtn, uploadSpinner, uploadBtnText, true);
            displayMessage(uploadMessage, "");

            const file = videoFileInput.files[0];
            if (!file) {
                displayMessage(uploadMessage, "Please select a video file.", true);
                setLoading(uploadBtn, uploadSpinner, uploadBtnText, false);
                return;
            }

            const formData = new FormData();
            formData.append('video', file); // 'video' matches the c.FormFile("video") in Go

            try {
                const data = await makeApiRequest(`/upload`, 'POST', formData, true); // Adjusted URL, isMultipart = true
                if (data) {
                    displayMessage(uploadMessage, `Upload successful! Video ID: ${data.video_status_id}. Status: ${data.message}`, false);
                    videoFileInput.value = ''; // Clear file input
                    loadVideos(); // Refresh video list
                }
            } catch (error) {
                console.error("Upload failed:", error);
                displayMessage(uploadMessage, `Upload failed: ${error.message}`, true);
            } finally {
                setLoading(uploadBtn, uploadSpinner, uploadBtnText, false);
            }
        }

        // Drag and Drop functionality
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('border-gray-600', 'bg-gray-50');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('border-gray-600', 'bg-gray-50');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-gray-600', 'bg-gray-50');
            videoFileInput.files = e.dataTransfer.files;
            // Optionally, trigger upload automatically or provide visual feedback
        });


        // --- Video Listing Logic ---
        async function loadVideos() {
            showSection('videoListSection'); // Show video list section
            videoTableBody.innerHTML = ''; // Clear existing list
            noVideosMessage.classList.add('hidden'); // Hide no videos message initially

            try {
                const videos = await makeApiRequest(`/videos/status`, 'GET'); // Adjusted URL
                if (videos && videos.length > 0) {
                    videos.forEach(video => {
                        const row = videoTableBody.insertRow();
                        row.className = 'hover:bg-gray-50';

                        row.insertCell().textContent = video.id;
                        row.insertCell().textContent = video.original_filename;
                        row.insertCell().textContent = video.status;
                        row.insertCell().textContent = new Date(video.created_at).toLocaleString();
                        row.insertCell().textContent = new Date(video.updated_at).toLocaleString();

                        const actionsCell = row.insertCell();
                        if (video.status === 'COMPLETED' && video.processed_file_path) {
                            const downloadBtn = document.createElement('button');
                            downloadBtn.textContent = 'Download';
                            downloadBtn.className = 'bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-xs focus:outline-none focus:shadow-outline';
                            downloadBtn.onclick = () => downloadVideo(video.id, video.original_filename);
                            actionsCell.appendChild(downloadBtn);
                        } else if (video.status === 'FAILED' && video.error_message) {
                            const errorSpan = document.createElement('span');
                            errorSpan.textContent = `Error: ${video.error_message.substring(0, 30)}...`;
                            errorSpan.className = 'text-red-500 text-xs';
                            actionsCell.appendChild(errorSpan);
                        } else {
                            actionsCell.textContent = '-';
                        }
                    });
                } else {
                    noVideosMessage.classList.remove('hidden'); // Show no videos message
                }
            } catch (error) {
                console.error("Failed to load videos:", error);
                displayMessage(noVideosMessage, `Failed to load videos: ${error.message}`, true);
                noVideosMessage.classList.remove('hidden');
            }
        }

        // --- Video Download Logic ---
        async function downloadVideo(videoId, originalFilename) {
            try {
                // Adjusted URL for download
                const blob = await makeApiRequest(`/videos/${videoId}/download`, 'GET');
                if (blob) {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // Provide a meaningful default filename
                    a.download = `${originalFilename.split('.')[0]}_processed.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url); // Clean up
                    a.remove();
                }
            } catch (error) {
                console.error("Download failed:", error);
                alert(`Failed to download: ${error.message}`);
            }
        }

        // --- Event Listeners ---
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (isLoginMode) {
                login();
            } else {
                register();
            }
        });

        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode();
        });

        logoutBtn.addEventListener('click', () => {
            removeToken();
            loggedInUserSpan.textContent = '';
            logoutBtn.classList.add('hidden');
            showSection('authSection');
            displayMessage(authMessage, "Logged out successfully.", false);
        });

        uploadForm.addEventListener('submit', uploadVideo);
        refreshVideosBtn.addEventListener('click', loadVideos);

        // Initial check on page load
        document.addEventListener('DOMContentLoaded', () => {
            submitAuthBtn.dataset.originalText = 'Login'; // Initialize original text
            uploadBtn.dataset.originalText = 'Upload'; // Initialize original text

            if (getToken()) {
                const user = parseJwt(getToken());
                if (user && user.exp * 1000 > Date.now()) { // Check token expiration
                    loggedInUserSpan.textContent = `Welcome, ${user.username}!`;
                    logoutBtn.classList.remove('hidden');
                    showSection('uploadSection'); // Or video list directly
                    loadVideos(); // Load videos on authenticated start
                } else {
                    removeToken(); // Token expired
                    showSection('authSection');
                }
            } else {
                showSection('authSection');
            }

            // Auto-refresh videos every 10 seconds if logged in and on video list section
            setInterval(() => {
                if (getToken() && !videoListSection.classList.contains('hidden')) {
                    loadVideos();
                }
            }, 10000); // Every 10 seconds
        });

    </script>
</body>
</html>